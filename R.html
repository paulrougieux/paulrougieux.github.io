<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Paul Rougieux" />

<meta name="date" content="2017-08-17" />

<title>R.knit</title>

<script src="site_libs/header-attrs-2.23/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.4.0/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Paul Rougieux</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-wrench"></span>
     
    Tools
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="bash.html">Bash</a>
    </li>
    <li>
      <a href="communication.html">Communication</a>
    </li>
    <li>
      <a href="debian.html">Debian</a>
    </li>
    <li>
      <a href="docker.html">Docker</a>
    </li>
    <li>
      <a href="git.html">Git</a>
    </li>
    <li>
      <a href="latex_and_lyx.html">Latex and Lyx</a>
    </li>
    <li>
      <a href="markdown.html">Markdown</a>
    </li>
    <li>
      <a href="mysql.html">MySQL</a>
    </li>
    <li>
      <a href="postgresql.html">PostgreSQL</a>
    </li>
    <li>
      <a href="publish.html">Publish</a>
    </li>
    <li>
      <a href="python.html">Python</a>
    </li>
    <li>
      <a href="R.html">R</a>
    </li>
    <li>
      <a href="vim.html">Vim</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-microchip"></span>
     
    Algos
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="carbon_budget_model.html">Carbon Budget Model</a>
    </li>
    <li>
      <a href="musical_scales.html">Musical scales</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    <span class="fa fa-line-chart"></span>
     
    Data
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="explore.html">Explore</a>
    </li>
    <li>
      <a href="datasources.html">Sources</a>
    </li>
  </ul>
</li>
<li>
  <a href="events.html">
    <span class="fa fa-users"></span>
     
    Events
  </a>
</li>
<li>
  <a href="publications.html">
    <span class="fa fa-book"></span>
     
    Publications
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">




</div>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This page is the continuation of <a
href="https://paulremote.blogspot.de/2014/04/r-commands.html">my blog
post on R commands</a>. On the blog, see also <a
href="http://paulremote.blogspot.fr/2013/10/why-r.html">why use R</a>
and the <a
href="http://paulremote.blogspot.com/feeds/posts/default/-/R">RSS feed
of posts labelled R</a>.</p>
<p>See also documentation at:</p>
<ul>
<li>The Comprehensive R Archive Network CRAN <a
href="https://cran.r-project.org/manuals.html">manuals</a></li>
<li>The Tidyverse <a
href="http://www.tidyverse.org/packages/">packages</a></li>
</ul>
<div id="history-of-r" class="section level2">
<h2>History of R</h2>
<p><a
href="https://en.wikipedia.org/wiki/Exploratory_data_analysis">Exploratory
data analysis</a></p>
<blockquote>
<p>“Tukey defined data analysis in 1961 as:”Procedures for analyzing
data, techniques for interpreting the results of such procedures, ways
of planning the gathering of data to make its analysis easier, more
precise or more accurate, and all the machinery and results of
(mathematical) statistics which apply to analyzing data. Tukey’s
championing of EDA encouraged the development of statistical computing
packages, especially S at Bell Labs. The S programming language inspired
the systems S-PLUS and R. This family of statistical-computing
environments featured vastly improved dynamic visualization
capabilities, which allowed statisticians to identify outliers, trends
and patterns in data that merited further study.”</p>
</blockquote>
<p><a href="https://en.wikipedia.org/wiki/S_(programming_language)">S
programming language</a></p>
<blockquote>
<p>“S is one of several statistical computing languages that were
designed at Bell Laboratories, and first took form between 1975–1976. Up
to that time, much of the statistical computing was done by directly
calling Fortran subroutines; however, S was designed to offer an
alternate and more interactive approach, motivated in part by
exploratory data analysis advocated by John Tukey. Early design
decisions that hold even today include interactive graphics devices
(printers and character terminals at the time), and providing easily
accessible documentation for the functions.”</p>
</blockquote>
<p>See also the comparison between R and Python below.</p>
</div>
</div>
<div id="control-flow" class="section level1">
<h1>Control flow</h1>
<p>dplyr::case_when is a generalised vectorised if. Example use:</p>
<pre><code> x &lt;- 1:50
 case_when(
   x %% 35 == 0 ~ &quot;fizz buzz&quot;,
   x %% 5 == 0 ~ &quot;fizz&quot;,
   x %% 7 == 0 ~ &quot;buzz&quot;,
   TRUE ~ as.character(x)
 )</code></pre>
</div>
<div id="data-table" class="section level1">
<h1>Data table</h1>
<p><a href="https://h2oai.github.io/db-benchmark/#task">Database like
operation benchmark</a> between data table, dplyr, python pandas and
other database like tools.</p>
</div>
<div id="data-types" class="section level1">
<h1>Data types</h1>
<div id="data-frames" class="section level2">
<h2>Data frames</h2>
<p>The data type used in must analysis. Data frames are an aligned
collection of vectors with observation in rows and variables in
columns.</p>
<div id="size-in-memory" class="section level3">
<h3>Size in memory</h3>
<p>Print the size of a data frame in memory</p>
<pre><code>print(object.size(df), units=&quot;MB&quot;)</code></pre>
</div>
</div>
<div id="vectors" class="section level2">
<h2>Vectors</h2>
<div id="everything-is-a-vector" class="section level3">
<h3>Everything is a vector</h3>
<p>There are no scalar values in R, only vectors, this makes it very
natural to process times series or cross sectional data over many N
observations as if we were processing only one instance of the
variable.</p>
<p><a href="https://stackoverflow.com/a/7500961/2641825">SO answer
concerning indexing up to end of vector/matrix</a> “Sometimes it’s
easier to tell R what you don’t want”</p>
<pre><code>x &lt;- c(5,5,4,3,2,1)
x[-(1:3)]
x[-c(1,3,6)]</code></pre>
<div id="set-operations" class="section level4">
<h4>Set operations</h4>
<pre class="r"><code>x = letters[1:3]
y = letters[3:5]
union(x, y)</code></pre>
<pre><code>## [1] &quot;a&quot; &quot;b&quot; &quot;c&quot; &quot;d&quot; &quot;e&quot;</code></pre>
<pre class="r"><code>intersect(x, y)</code></pre>
<pre><code>## [1] &quot;c&quot;</code></pre>
<pre class="r"><code>setdiff(x, y)</code></pre>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
<pre class="r"><code>setdiff(y, x)</code></pre>
<pre><code>## [1] &quot;d&quot; &quot;e&quot;</code></pre>
<pre class="r"><code>setequal(x, y)</code></pre>
<pre><code>## [1] FALSE</code></pre>
</div>
</div>
<div id="dates" class="section level3">
<h3>Dates</h3>
<p>Create a date vector</p>
<pre><code>as.Date(&quot;2022-01-01&quot;)
seq(as.Date(&quot;2022-01-01&quot;), by=1, len=3)</code></pre>
<p>Parse a character vector into a date vector with lubridate</p>
<pre><code>tralala_chr &lt;- c(&quot;202012&quot;, &quot;202101&quot;)
tralala &lt;- lubridate::parse_date_time(tralala_chr, &quot;%y%m&quot;)
tralala</code></pre>
<p>Represent the date object as a string</p>
<pre><code>format(min(tralala),&quot;%Y-%m&quot;)
format(max(tralala),&quot;%Y-%m&quot;) </code></pre>
</div>
<div id="factors" class="section level3">
<h3>Factors</h3>
<p><a
href="https://stackoverflow.com/questions/45148897/how-to-reorder-factor-levels-in-a-tidy-way/59246372#59246372">My
answer to the question how to reorder factor levels the tidy way</a></p>
<p>If you happen to have a character vector to order, for example:</p>
<pre><code>iris2 &lt;- iris %&gt;%
    mutate(Species = as.character(Species)) %&gt;%
    group_by(Species) %&gt;%
    mutate(mean_sepal_width = mean(Sepal.Width)) %&gt;%
    ungroup()</code></pre>
<p>You can also order the factor level using the behavior of the
forcats::as_factor function :</p>
<pre><code>&quot;Compared to base R, this function creates levels in the order in which they appear&quot;

library(forcats)
iris2 %&gt;%
    # Change the order
    arrange(mean_sepal_width) %&gt;%
    # Create factor levels in the order in which they appear
    mutate(Species = forcats::as_factor(Species)) %&gt;%
    ggplot() +
    aes(Species, Sepal.Width, color = Species) +
    geom_point()</code></pre>
<p>Notice how the species names on the x axis are not ordered
alphabetically but by increasing value of their mean_sepal_width. Remove
the line containing as_factor to see the difference.</p>
</div>
<div id="strings" class="section level3">
<h3>Strings</h3>
<pre class="r"><code>message(&quot;Using the following letters: &quot;, paste(letters, collapse=&quot;,&quot;), &quot;.&quot;)</code></pre>
<pre><code>## Using the following letters: a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z.</code></pre>
<ul>
<li><p><a
href="https://simplystatistics.org/posts/2015-07-24-stringsasfactors-an-unauthorized-biography/">stringsAsFactors:
An unauthorized biography</a></p>
<blockquote>
<p>“The argument ‘stringsAsFactors’ is an argument to the ‘data.frame()’
function in R. It is a logical that indicates whether strings in a data
frame should be treated as factor variables or as just plain strings.
[…] By default, ‘stringsAsFactors’ is set to TRUE.” “Most people I talk
to today who use R are completely befuddled by the fact that
‘stringsAsFactors’ is set to TRUE by default. […]” “In the old days,
when R was primarily being used by statisticians and statistical types,
this setting strings to be factors made total sense. In most tabular
data, if there were a column of the table that was non-numeric, it
almost certainly encoded a categorical variable. Think sex
(male/female), country (U.S./other), region (east/west), etc. In R,
categorical variables are represented by ‘factor’ vectors and so
character columns got converted factor. […] Why do we need factor
variables to begin with? Because of modeling functions like ‘lm()’ and
‘glm()’. Modeling functions need to treat expand categorical variables
into individual dummy variables, so that a categorical variable with 5
levels will be expanded into 4 different columns in your modeling
matrix.” […]</p>
</blockquote>
<blockquote>
<p>“Around June of 2007, R introduced hashing of CHARSXP elements in the
underlying C code thanks to Seth Falcon. What this meant was that
effectively, character strings were hashed to an integer representation
and stored in a global table in R. Anytime a given string was needed in
R, it could be referenced by its underlying integer. This effectively
put in place, globally, the factor encoding behavior of strings from
before. Once this was implemented, there was little to be gained from an
efficiency standpoint by encoding character variables as factor. Of
course, you still needed to use ‘factors’ for the modeling
functions.”</p>
</blockquote></li>
</ul>
<div id="levenshtein-distance-between-words" class="section level4">
<h4>Levenshtein distance between words</h4>
<p>Cf. <a href="https://en.wikipedia.org/wiki/Levenshtein_distance"
class="uri">https://en.wikipedia.org/wiki/Levenshtein_distance</a> and
<code>help(adist)</code>.</p>
<pre class="r"><code>adist(&quot;kitten&quot;, &quot;sitting&quot;)</code></pre>
<pre><code>##      [,1]
## [1,]    3</code></pre>
</div>
<div id="capitalise-first-letter" class="section level4">
<h4>Capitalise first letter</h4>
<p>Capitalise the first letter of each word</p>
<pre><code>stringr::str_to_title(&quot;bla bla bla&quot;)
# [1] &quot;Bla Bla Bla&quot;</code></pre>
</div>
</div>
</div>
<div id="lists" class="section level2">
<h2>Lists</h2>
<p>Given a list structure x, unlist simplifies it to produce a vector
which contains all the atomic components which occur in x.</p>
<pre class="r"><code>l1 &lt;- list(a=&quot;a&quot;, b=&quot;2,&quot;, c=&quot;pi+2i&quot;)
str(l1)</code></pre>
<pre><code>## List of 3
##  $ a: chr &quot;a&quot;
##  $ b: chr &quot;2,&quot;
##  $ c: chr &quot;pi+2i&quot;</code></pre>
<pre class="r"><code>unlist(l1) # a character vector </code></pre>
<pre><code>##       a       b       c 
##     &quot;a&quot;    &quot;2,&quot; &quot;pi+2i&quot;</code></pre>
<pre class="r"><code>str(unlist(l1))</code></pre>
<pre><code>##  Named chr [1:3] &quot;a&quot; &quot;2,&quot; &quot;pi+2i&quot;
##  - attr(*, &quot;names&quot;)= chr [1:3] &quot;a&quot; &quot;b&quot; &quot;c&quot;</code></pre>
<p>Extract the first element of a nested list <a
href="https://stackoverflow.com/questions/20428742/select-first-element-of-nested-list">SO</a></p>
<pre class="r"><code>minyearmaxyear &lt;- list(c(2001, 2009), c(2010, 2014), c(2015, 2100))
library(purrr)
map(minyearmaxyear, 1)</code></pre>
<pre><code>## [[1]]
## [1] 2001
## 
## [[2]]
## [1] 2010
## 
## [[3]]
## [1] 2015</code></pre>
<div id="remove-items-from-a-list" class="section level3">
<h3>Remove items from a list</h3>
<p><a href="https://stackoverflow.com/a/50143588/2641825">Remove
elements from a named list</a> in R.</p>
<pre><code>l &lt;- list(a = 1, b = 2)
l &lt;- within(l, rm(a)) </code></pre>
<p><a href="https://stackoverflow.com/a/4685169/2641825">Remove elements
from an unnamed list</a></p>
<pre><code>l &lt;- list(1,2)
l[1] &lt;- NULL</code></pre>
</div>
<div id="bind-data-frames-in-a-list" class="section level3">
<h3>Bind data frames in a list</h3>
<p><a href="https://stackoverflow.com/a/72277344/2641825">Bind data
frames in a list</a></p>
<pre><code># Large list if data frames
l_df &lt;- list(head(iris), iris[c(92:95),], tail(iris))
df_stack &lt;- data.frame()
for (i in 1:length(l_df)){
    # Bind the first list item and remove it
    df_stack &lt;- rbind(df_stack, l_df[[1]])
    l_df[1] &lt;- NULL
}
# Reset row names
row.names(df_stack) &lt;- NULL</code></pre>
<p>This will take less memory than binding the data frame in this
way:</p>
<pre><code>l_df &lt;- list(head(iris), iris[c(92:95),], tail(iris))
dfdt = data.table::rbindlist(l_df)</code></pre>
<p>And should give a similar result</p>
<pre><code>identical(df_stack, data.frame(dfdt))
# TRUE</code></pre>
</div>
</div>
<div id="s3-methods" class="section level2">
<h2>S3 methods</h2>
<p>List all available methods for a class:</p>
<pre><code>methods(class=&quot;lm&quot;) </code></pre>
</div>
</div>
<div id="debug" class="section level1">
<h1>Debug</h1>
<p><a href="https://adv-r.hadley.nz/debugging.html#debugging">Hadley
Wickham on debugging</a></p>
<blockquote>
<p>“NB: You shouldn’t need to use these tools when writing new
functions. If you find yourself using them frequently with new code,
reconsider your approach. Instead of trying to write one big function
all at once, work interactively on small pieces. If you start small, you
can quickly identify why something doesn’t work, and don’t need
sophisticated debugging tools.”</p>
</blockquote>
<div id="debug-with-base-r" class="section level2">
<h2>Debug with base R</h2>
<p>Print the call stack of the last error:</p>
<pre><code>traceback()</code></pre>
<p>Start a <a
href="https://adv-r.hadley.nz/debugging.html#browser-commands">browser
at a particular position in code</a>:</p>
<pre><code> browser()</code></pre>
<blockquote>
<p>Next, n: executes the next step in the function. If you have a
variable named n, you’ll need print(n) to display its value.</p>
</blockquote>
<blockquote>
<p>Step into, or s: works like next, but if the next step is a function,
it will step into that function so you can explore it interactively.</p>
</blockquote>
<blockquote>
<p>Finish, or f: finishes execution of the current loop or function.</p>
</blockquote>
<blockquote>
<p>Continue, c: leaves interactive debugging and continues regular
execution of the function. This is useful if you’ve fixed the bad state
and want to check that the function proceeds correctly.</p>
</blockquote>
<blockquote>
<p>Stop, Q: stops debugging, terminates the function, and returns to the
global workspace. Use this once you’ve figured out where the problem is,
and you’re ready to fix it and reload the code.</p>
</blockquote>
</div>
<div id="debug-with-rlang" class="section level2">
<h2>Debug with rlang</h2>
<p>Print the call stack of the last error in simplified form:</p>
<pre><code>rlang::last_error()</code></pre>
<p>Print the full call stack of the last error:</p>
<pre><code>rlang::last_trace()</code></pre>
<p>More information on the behaviour of backtrace:</p>
<pre><code>help(trace_back, package=rlang)</code></pre>
<blockquote>
<p>“Because of lazy evaluation, the call stack in R is actually a tree,
which the ‘summary()’ method of this object will reveal.”</p>
</blockquote>
</div>
</div>
<div id="environnement" class="section level1">
<h1>Environnement</h1>
<div id="r-environment" class="section level2">
<h2>R environment</h2>
<p>List objects in the global environment:</p>
<pre><code>ls</code></pre>
<p>List objects coming from a specific loaded package:</p>
<pre><code>ls(&quot;package:stats&quot;)
ls(&quot;package:stats&quot;, pattern=&quot;smooth&quot;)</code></pre>
<p>Remove all objects in the environment except one:</p>
<pre><code>rm(list=ls()[!ls()==&quot;object_to_keep&quot;]) 
rm(list=ls()[!ls()==&quot;con&quot;]) # Remove all except a database connection</code></pre>
<p>Get the current environment</p>
<pre><code>rlang::current_env()</code></pre>
</div>
<div id="read-system-environment-variables" class="section level2">
<h2>Read system environment variables</h2>
<p>Read an environment variable from the operating system</p>
<pre><code>data_path &lt;- Sys.getenv(&quot;PROJECT_DATA&quot;)</code></pre>
</div>
</div>
<div id="editors" class="section level1">
<h1>Editors</h1>
<p>I use Vim and the great <a
href="https://github.com/jalvesaq/Nvim-R">Nvim-R</a> plugin to edit R
markdown documents and R scripts. I browse the table of content of R
markdown files with the Voom plugin. I create R packages with Makefiles.
I use the fugitive plugin to manage my git commits. See my <a
href="Vim.html">Vim page</a> for more information.</p>
<p>Rstudio is a great editors for those who prefer a graphical user
interface. It has a Vim mode. In fact I trained my muscle memory for Vim
movement keys inside RStudio initially. Rstudio also has a lot of menus
and buttons to work with Rmarkdown documents, view the state of a git
repository and build packages.</p>
</div>
<div id="input-output" class="section level1">
<h1>Input output</h1>
<pre><code>getwd()
list.files(tempdir()) 
dir.create(&quot;blabla&quot;)</code></pre>
<div id="apache-arrow-and-parquet-files" class="section level2">
<h2>Apache Arrow and parquet files</h2>
<p><a href="https://github.com/apache/arrow/tree/master/r">Apache arrow
R packages</a></p>
<blockquote>
<p>“Read and write Feather files (read_feather(), write_feather()), a
format optimized for speed and interoperability”</p>
</blockquote>
<pre><code>library(arrow)
read_parquet() # to read a single file
open_dataset() # to open a dataset sharded over multiple files</code></pre>
<p>help(open_dataset)</p>
<blockquote>
<p>” Call ‘open_dataset()’ to point to a directory of data files and
return a ‘Dataset’, then use ‘dplyr’ methods to query it.”’</p>
</blockquote>
<pre class="r"><code>library(arrow)
library(dplyr)
# Set up directory for examples
tf &lt;- tempfile()
dir.create(tf)
on.exit(unlink(tf))

data &lt;- dplyr::group_by(iris, Species)
write_dataset(data, tf)

# open only the setosa part
setosa &lt;- open_dataset(tf) %&gt;%
    filter(Species == &quot;setosa&quot;) %&gt;%
    collect()</code></pre>
</div>
<div id="csv-files" class="section level2">
<h2>CSV files</h2>
<p>Read one csv file with default R function.</p>
<pre><code>read.csv(&quot;data.csv&quot;, )</code></pre>
<p>Read many csv files with functions from the tidyverse packages.</p>
<p>First write sample csv files to a temporary directory. It’s more
complicated than I thought it would be.</p>
<pre><code>library(dplyr)
library(purrr)
library(purrrlyr)
library(readr)
data_folder &lt;- file.path(tempdir(), &quot;iris&quot;)
dir.create(data_folder)
iris %&gt;%
    # Keep the Species column in the output
    # Create a new column that will be used as the grouping variable
    mutate(species_group = Species) %&gt;% 
    group_by(species_group) %&gt;%
    nest() %&gt;%
    by_row(~write.csv(.$data, 
                      file = file.path(data_folder, paste0(.$species_group, &quot;.csv&quot;)),
                      row.names = FALSE))</code></pre>
<p>Read these csv files into one data frame. Note the Species column has
to be present in the csv files, otherwise we would loose that
information.</p>
<pre><code>iris_csv &lt;- list.files(data_folder, full.names = TRUE) %&gt;% 
    map_dfr(read_csv)</code></pre>
<p><code>write_csv</code> returned an
<code>Error in write_delim(...) is.data.frame(x) is not TRUE</code>
That’s why we used <code>write.csv</code> instead.</p>
</div>
<div id="rds-files" class="section level2">
<h2>RDS files</h2>
<p>RDS is a Serialization Interface for Single Objects. Objects are
saved to binary data and compressed to the gzip format, see
<code>help(saveRDS)</code> for more details.</p>
<p>Write a dataset to an rds file:</p>
<pre><code>saveRDS(iris, &quot;/tmp/iris.rds&quot;)</code></pre>
<p>Read a dataset from an rds file</p>
<pre><code>iris2 &lt;- readRDS(&quot;/tmp/iris.rds&quot;)
identical(iris, iris2)</code></pre>
</div>
<div id="databases" class="section level2">
<h2>Databases</h2>
<p>Dplyr has databases backends to MySQl (MariaDB) and PostgreSQL.</p>
</div>
<div id="create-directories" class="section level2">
<h2>Create directories</h2>
<p>Create a directory do not show a warning if it exists already.</p>
<pre><code>dir_path = &quot;/tmp/blabla/&quot;
dir.create(dir_path, showWarnings = FALSE)</code></pre>
</div>
</div>
<div id="find-and-replace" class="section level1">
<h1>Find and replace</h1>
<div id="longest-contiguous-stretch-of-non-nas" class="section level2">
<h2>Longest contiguous stretch of non-NAs:</h2>
<pre><code>na.contiguous(c(NA,1:3,NA,NA,3:5,NA,NA))
] 1 2 3
tr(,&quot;na.action&quot;)
]  1  5  6  7  8  9 10 11
tr(,&quot;class&quot;)
] &quot;omit&quot;
tr(,&quot;tsp&quot;)
] 2 4 1
na.contiguous(c(NA,1:3,NA,NA,3:6,NA,NA))
] 3 4 5 6
tr(,&quot;na.action&quot;)
]  1  2  3  4  5  6 11 12
tr(,&quot;class&quot;)
] &quot;omit&quot;
tr(,&quot;tsp&quot;)
]  7 10  1</code></pre>
</div>
<div id="replace-text-in-column-names" class="section level2">
<h2>Replace text in column names</h2>
<p>Add the first row to the column name, useful for some double headed
csv files coming from pandas.</p>
<pre><code>paste(names(df), df[1,])</code></pre>
<p>Replace a regular expression with optional numerical pattern and
final space</p>
<pre><code>names(df) &lt;- gsub(&quot;.per.hectare.[0-9]* *&quot;, &quot;_&quot;, names(df))</code></pre>
<p>Using and, or <a
href="https://stackoverflow.com/questions/18237852/grep-in-r-using-or-and-not/18239222">in
a regular expression</a></p>
<pre><code>|</code></pre>
<p>Change columns to snake case</p>
<pre class="r"><code>column_names &lt;- c(&quot;Bla, Bla&quot;, &quot;Hips, Hops&quot;, &quot;Yield/Carcass Weight&quot;,
                  &quot;Production&quot;, &quot;Producing Animals/Slaughtered&quot;,
                  &quot;Area harvested&quot;, &quot;Yield&quot;)
gsub(&quot;[^[:alnum:]]&quot;,&quot;_&quot;,tolower(column_names))</code></pre>
<pre><code>## [1] &quot;bla__bla&quot;                      &quot;hips__hops&quot;                   
## [3] &quot;yield_carcass_weight&quot;          &quot;production&quot;                   
## [5] &quot;producing_animals_slaughtered&quot; &quot;area_harvested&quot;               
## [7] &quot;yield&quot;</code></pre>
<pre class="r"><code># Replace one or more occurrences by an underscore
gsub(&quot;[^[:alnum:]]+&quot;,&quot;_&quot;,tolower(column_names))</code></pre>
<pre><code>## [1] &quot;bla_bla&quot;                       &quot;hips_hops&quot;                    
## [3] &quot;yield_carcass_weight&quot;          &quot;production&quot;                   
## [5] &quot;producing_animals_slaughtered&quot; &quot;area_harvested&quot;               
## [7] &quot;yield&quot;</code></pre>
<pre class="r"><code>iris2 &lt;- iris
names(iris2) &lt;- gsub(&quot;[^[:alnum:]]+&quot;,&quot;_&quot;,tolower(names(iris2)))
print(names(iris))</code></pre>
<pre><code>## [1] &quot;Sepal.Length&quot; &quot;Sepal.Width&quot;  &quot;Petal.Length&quot; &quot;Petal.Width&quot;  &quot;Species&quot;</code></pre>
<pre class="r"><code># [1] &quot;sepal_length&quot; &quot;sepal_width&quot;  &quot;petal_length&quot; &quot;petal_width&quot;  &quot;species&quot;</code></pre>
</div>
</div>
<div id="installing-r-and-packages" class="section level1">
<h1>Installing R and packages</h1>
<p>To install R and Rstudio on Debian, see the <a
href="debian.html#r_and_rstudio">debian.html#r_and_rstudio</a> page on
this site.</p>
<p>To install packages simply enter the following at an R command
prompt:</p>
<pre><code>install.packages(&quot;package_name&quot;)</code></pre>
<p>Some packages have dependencies that need to be installed at the OS
level. Error messages:</p>
<pre><code>&quot;Configuration failed because libcurl was not found.&quot; 
&quot;Configuration failed because libxml-2.0 was not found.&quot;
&quot;Configuration failed because openssl was not found.&quot;</code></pre>
<p>Can be solved by installing these dependencies:</p>
<pre><code>sudo apt install libcurl4-openssl-dev 
sudo apt install libxml2-dev 
sudo apt install libssl-dev</code></pre>
<div id="install-from-source-file" class="section level2">
<h2>Install from source file</h2>
<p>To install from a source file</p>
<pre><code>install.packages(&quot;~/rp/FAOSTATpackage/FAOSTAT_2.2.1.tar.gz&quot;, repos=NULL)</code></pre>
<p>System information used by <code>install.packages()</code> to
determine default installation parameters</p>
<pre><code>getOption(&quot;repos&quot;)
getOption(&quot;pkgType&quot;)</code></pre>
</div>
<div id="eurostat-package" class="section level2">
<h2>Eurostat Package</h2>
<p>Install required GDAL development library for the “sf” package</p>
<pre><code>sudo apt install libgdal-dev</code></pre>
<p>Then at the R prompt</p>
<pre><code>install.packages(&quot;eurostat&quot;)</code></pre>
</div>
</div>
<div id="information-about-your-r-system" class="section level1">
<h1>Information about your R system</h1>
<pre class="r"><code>sessionInfo()
installed.packages()</code></pre>
</div>
<div id="r-markdown" class="section level1">
<h1>R Markdown</h1>
<div id="create-websites" class="section level2">
<h2>Create websites</h2>
<div id="rmarkdown-site-generator" class="section level3">
<h3>Rmarkdown site generator</h3>
<p>This website is generated from R Markdown documents with:</p>
<pre><code> Rscript -e &quot;rmarkdown::render_site()&quot;</code></pre>
<p>The advantage of the rmarkdown site generator is that it creates
pages with a floating, foldable table of content. It’s nice for pages
that have a lot of subdivisions like this blog. The structure of a
website is specified in a yaml file. For example, the code below creates
a navigation bar:</p>
<pre><code>navbar:
  title: &quot;Paul Rougieux&quot;
  left:
    - text: &quot;Home&quot;
      icon: fa-home 
      href: index.html
    - text: &quot;Tools&quot;
      icon: fa-wrench
      menu:
        - text: &quot;Bash&quot;
          href: bash.html</code></pre>
</div>
<div id="bookdown-site-generator" class="section level3">
<h3>Bookdown site generator</h3>
<p>For blogs that fit into a book structure, with chapters, the bookdown
package create a single clickable table of content for the whole site.
It can also export the content to pdf format.</p>
<p>Specifying input from many sub directories in
<code>_bookdown.yml</code>:</p>
<pre><code>rmd_files: [&quot;index.Rmd&quot;, &quot;chapters/chapt1.RMD&quot;, &quot;chapters/chapt2.RMD&quot;]</code></pre>
<p>Attention this will only work in the Merge and Knit strategy, as
explained in the <a
href="https://bookdown.org/yihui/bookdown/new-session.html">book chapter
on two rendering approaches</a></p>
<blockquote>
<p>“We call these two approaches “Merge and Knit” (M-K) and “Knit and
Merge” (K-M), respectively.” “K-M does not allow Rmd files to be in
subdirectories, but M-K does.”</p>
</blockquote>
</div>
</div>
<div id="cross-references" class="section level2">
<h2>Cross references</h2>
<p><a
href="https://bookdown.org/yihui/rmarkdown-cookbook/cross-ref.html">R
markdown cross ref</a></p>
<blockquote>
<p>“Cross-referencing is not provided directly within the base rmarkdown
package, but is provided as an extension in bookdown (Xie 2020c). We
must therefore use an output format from bookdown (e.g., html_document2,
pdf_document2, and word_document2, etc.) in the YAML output field.”</p>
</blockquote>
<ul>
<li>Bookdown issue with flextable <a
href="https://github.com/rstudio/bookdown/issues/746">Table and figure
cross references in word</a> Now solved with the following
implementation</li>
</ul>
<pre class="r"><code>iris %&gt;% head() %&gt;% flextable()</code></pre>
<p>This is a reference to flextable @ref(tab:irishead). The chunk name
should not contain an underscore, otherwise the cross reference will not
work. See <a
href="https://github.com/rstudio/bookdown/issues/941">bookdown issue
941</a>.</p>
<p>See more flextable caption examples in
<code>system.file(package = "flextable", "examples", "rmd", "captions")</code></p>
</div>
<div id="flextable-and-officer-package" class="section level2">
<h2>Flextable and officer package</h2>
<p>The officer package makes it possible to create improved word and
powerpoint documents. The flextable package has a few functions to
generate tables for word documents (otherwise they look funny).</p>
<p>Before installing flextable, the following system dependencies were
required:</p>
<pre><code>sudo apt install libcairo2-dev libjpeg-dev libgif-dev</code></pre>
<p>Installation in R:</p>
<pre><code>install.packages(&quot;flextable&quot;)</code></pre>
<p>This is to work with colleagues who are not in the latex/pdf
world.</p>
<div id="landscape-pages" class="section level3">
<h3>Landscape pages</h3>
<pre class="r"><code>library(officer)
library(flextable)
ft_iris &lt;- iris %&gt;%
    head() %&gt;%
    flextable() %&gt;%
    autofit()
# Add a flex table in landscape format 
# Supply document name here, otherwise start an empty doc
doc &lt;- read_docx() %&gt;% 
  # Portait and landscape sections are defined by their ending
  # A portrait section is ending here
  body_end_section_portrait() %&gt;%
  body_add_flextable(value = ft_iris, split = TRUE) %&gt;%
  # A landscape section is ending here
  body_end_section_landscape() %&gt;% 
  print(target = &quot;/tmp/iris.docx&quot;)</code></pre>
</div>
</div>
<div id="kable-to-create-tables" class="section level2">
<h2>kable to create tables</h2>
<p>A table caption</p>
<pre class="r"><code>knitr::kable(head(iris), caption = &quot;An example table caption.&quot;)</code></pre>
<table>
<caption>An example table caption.</caption>
<thead>
<tr class="header">
<th align="right">Sepal.Length</th>
<th align="right">Sepal.Width</th>
<th align="right">Petal.Length</th>
<th align="right">Petal.Width</th>
<th align="left">Species</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">5.1</td>
<td align="right">3.5</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.9</td>
<td align="right">3.0</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">4.7</td>
<td align="right">3.2</td>
<td align="right">1.3</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">4.6</td>
<td align="right">3.1</td>
<td align="right">1.5</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="odd">
<td align="right">5.0</td>
<td align="right">3.6</td>
<td align="right">1.4</td>
<td align="right">0.2</td>
<td align="left">setosa</td>
</tr>
<tr class="even">
<td align="right">5.4</td>
<td align="right">3.9</td>
<td align="right">1.7</td>
<td align="right">0.4</td>
<td align="left">setosa</td>
</tr>
</tbody>
</table>
<p>Examples copie from yihui’s <a
href="https://bookdown.org/yihui/rmarkdown-cookbook/kable.html#kable-caption">R
markdown cookbook</a>.</p>
<pre class="r"><code>set.seed(100)
d &lt;- cbind(X1 = runif(3), 
           X2 = 10^c(3, 5, 7), 
           X3 = rnorm(3, 0, 1000))
# at most 4 decimal places
knitr::kable(d, digits = 4)</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">X1</th>
<th align="right">X2</th>
<th align="right">X3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.3078</td>
<td align="right">1e+03</td>
<td align="right">-1585.8810</td>
</tr>
<tr class="even">
<td align="right">0.2577</td>
<td align="right">1e+05</td>
<td align="right">-40.6920</td>
</tr>
<tr class="odd">
<td align="right">0.5523</td>
<td align="right">1e+07</td>
<td align="right">-331.0045</td>
</tr>
</tbody>
</table>
<pre class="r"><code># round columns separately
knitr::kable(d, digits = c(5, 0, 2))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">X1</th>
<th align="right">X2</th>
<th align="right">X3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.30777</td>
<td align="right">1e+03</td>
<td align="right">-1585.88</td>
</tr>
<tr class="even">
<td align="right">0.25767</td>
<td align="right">1e+05</td>
<td align="right">-40.69</td>
</tr>
<tr class="odd">
<td align="right">0.55232</td>
<td align="right">1e+07</td>
<td align="right">-331.00</td>
</tr>
</tbody>
</table>
<pre class="r"><code># do not use the scientific notation
knitr::kable(d, digits = 3, format.args = list(scientific = FALSE))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">X1</th>
<th align="right">X2</th>
<th align="right">X3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.308</td>
<td align="right">1000</td>
<td align="right">-1585.881</td>
</tr>
<tr class="even">
<td align="right">0.258</td>
<td align="right">100000</td>
<td align="right">-40.692</td>
</tr>
<tr class="odd">
<td align="right">0.552</td>
<td align="right">10000000</td>
<td align="right">-331.005</td>
</tr>
</tbody>
</table>
<pre class="r"><code># add commas to big numbers
knitr::kable(d, digits = 3, format.args = list(big.mark = &quot;,&quot;,
  scientific = FALSE))</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">X1</th>
<th align="right">X2</th>
<th align="right">X3</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">0.308</td>
<td align="right">1,000</td>
<td align="right">-1,585.881</td>
</tr>
<tr class="even">
<td align="right">0.258</td>
<td align="right">100,000</td>
<td align="right">-40.692</td>
</tr>
<tr class="odd">
<td align="right">0.552</td>
<td align="right">10,000,000</td>
<td align="right">-331.005</td>
</tr>
</tbody>
</table>
<p>The format is recognised automatically by knitr based on the nature
of the output document.</p>
<pre class="r"><code>cat(kable(head(iris, 1), format = &quot;html&quot;))</code></pre>
<pre><code>## &lt;table&gt;
##  &lt;thead&gt;
##   &lt;tr&gt;
##    &lt;th style=&quot;text-align:right;&quot;&gt; Sepal.Length &lt;/th&gt;
##    &lt;th style=&quot;text-align:right;&quot;&gt; Sepal.Width &lt;/th&gt;
##    &lt;th style=&quot;text-align:right;&quot;&gt; Petal.Length &lt;/th&gt;
##    &lt;th style=&quot;text-align:right;&quot;&gt; Petal.Width &lt;/th&gt;
##    &lt;th style=&quot;text-align:left;&quot;&gt; Species &lt;/th&gt;
##   &lt;/tr&gt;
##  &lt;/thead&gt;
## &lt;tbody&gt;
##   &lt;tr&gt;
##    &lt;td style=&quot;text-align:right;&quot;&gt; 5.1 &lt;/td&gt;
##    &lt;td style=&quot;text-align:right;&quot;&gt; 3.5 &lt;/td&gt;
##    &lt;td style=&quot;text-align:right;&quot;&gt; 1.4 &lt;/td&gt;
##    &lt;td style=&quot;text-align:right;&quot;&gt; 0.2 &lt;/td&gt;
##    &lt;td style=&quot;text-align:left;&quot;&gt; setosa &lt;/td&gt;
##   &lt;/tr&gt;
## &lt;/tbody&gt;
## &lt;/table&gt;</code></pre>
<pre class="r"><code>cat(kable(head(iris, 1), format = &quot;latex&quot;))</code></pre>
<pre><code>## 
## \begin{tabular}{r|r|r|r|l}
## \hline
## Sepal.Length &amp; Sepal.Width &amp; Petal.Length &amp; Petal.Width &amp; Species\\
## \hline
## 5.1 &amp; 3.5 &amp; 1.4 &amp; 0.2 &amp; setosa\\
## \hline
## \end{tabular}</code></pre>
<pre class="r"><code>cat(kable(head(iris, 1), format = &quot;markdown&quot;))</code></pre>
<pre><code>## | Sepal.Length| Sepal.Width| Petal.Length| Petal.Width|Species | |------------:|-----------:|------------:|-----------:|:-------| |          5.1|         3.5|          1.4|         0.2|setosa  |</code></pre>
<div id="booktabs" class="section level3">
<h3>Booktabs</h3>
<p>Booktabs tables look nicer in latex document, they can be created by
specifying the argument <code>booktabs = TRUE</code> into the
<code>kable()</code> call.</p>
<p>Knitr adds an extra space every five lines into booktabs tables for
readability. This is undesirable for short tables. To remove this space
specify the <code>linesep = ""</code> argument to <code>kable()</code>
as explained in this <a
href="https://stackoverflow.com/questions/49015578/space-after-every-five-rows-in-kable-output-with-booktabs-option-in-r-markdown">SO
answer</a>.</p>
</div>
<div id="kableextra-formatting" class="section level3">
<h3>KableExtra formatting</h3>
<p>The package <code>kableExtra</code> can <a
href="https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Group_rows_via_multi-row_cell">group
rows via multi-row cells</a></p>
<p>Html format</p>
<pre><code>library(dplyr)
iris3 &lt;- iris %&gt;% group_by(Species) %&gt;% slice(1:3)
iris3 %&gt;%
    knitr::kable(format = &quot;html&quot;) %&gt;%
    kableExtra::collapse_rows(columns = 5, valign = &quot;top&quot;)</code></pre>
<p>Latex, pdf format</p>
<pre><code>iris3 %&gt;%
    knitr::kable(format = &quot;latex&quot;) %&gt;%
    kableExtra::collapse_rows(columns = 5, valign = &quot;top&quot;)</code></pre>
<p>Make wider columns</p>
<pre><code>iris %&gt;%
    knitr::kable(format = &#39;markdown&#39;, caption = &#39;Flower measurements&#39;) %&gt;%
    kableExtra::column_spec(5, width = &quot;30em&quot;)
`</code></pre>
</div>
</div>
<div id="output" class="section level2">
<h2>Output</h2>
<p>The default output is in HTML. The nature of the notebook output can
be defined in the preamble section of the R markdown document.</p>
<div id="pdf" class="section level3">
<h3>PDF</h3>
<p>It’s often useful to have a table of content at the start of long
documents.</p>
<pre><code>---
title: &quot;Title&quot;
date:  &quot;07 December, 2023&quot;
output:
  pdf_document:
    number_sections: yes
    toc: yes
---</code></pre>
<p>I usually have this line at the beginning of R markdown files to
generate the pdf output from command line:</p>
<pre><code>cd ~/rp/path_to_repo/notebooks/ &amp;&amp;  Rscript -e &quot;rmarkdown::render(&#39;file_name.Rmd&#39;, &#39;pdf_document&#39;)&quot;</code></pre>
</div>
<div id="power-point-documents" class="section level3">
<h3>Power point documents</h3>
<p>It’s possible to specify a power point template in the knitr preamble
as such:</p>
<pre><code>---
title: &quot;Title&quot;
output:
  powerpoint_presentation:
    reference_doc: presentation_template.pptx
---</code></pre>
<p>More details in <a
href="https://bookdown.org/yihui/rmarkdown/powerpoint-presentation.html"
class="uri">https://bookdown.org/yihui/rmarkdown/powerpoint-presentation.html</a>
I ran into some issues: - <a
href="https://stackoverflow.com/questions/56243502/how-to-fix-could-not-find-shape-for-powerpoint-content-error-pandoc-document-c"
class="uri">https://stackoverflow.com/questions/56243502/how-to-fix-could-not-find-shape-for-powerpoint-content-error-pandoc-document-c</a>
- <a href="https://github.com/jgm/pandoc/issues/5402"
class="uri">https://github.com/jgm/pandoc/issues/5402</a> And the fact
that I cannot edit the slide master from power point online is
annoying.</p>
</div>
<div id="figure-numbering" class="section level3">
<h3>Figure numbering</h3>
<p>Using bookdown it’s possible to use figure numbering as explain in
this <a href="https://stackoverflow.com/a/47029553/2641825">SO
answer</a></p>
<pre><code>---
output: bookdown::html_document2
---

# Section name {#id}

&lt;div class=&quot;figure&quot;&gt;
&lt;img src=&quot;R_files/figure-html/pressure-1.png&quot; alt=&quot;test plot&quot; width=&quot;672&quot; /&gt;
&lt;p class=&quot;caption&quot;&gt;test plot&lt;/p&gt;
&lt;/div&gt;

To cross-reference the figure, use `\@ref(fig:pressure)` 
to produce Figure \@ref(fig:pressure). All this is found within the section \@ref(id).</code></pre>
<p>This doesn’t work with word documents because the word document
format is not available for bookdown.</p>
</div>
<div id="word-document" class="section level3">
<h3>Word document</h3>
<p>Render an Rmarkdown notebook as word document with the rmarkdown
package:</p>
<pre><code>Rscript -e &quot;rmarkdown::render(&#39;chapter.Rmd&#39;, output_format=&#39;word_document&#39;)&quot;</code></pre>
<p>Sample Rmarkdown document to be rendered with quarto</p>
<pre><code>---
title: &quot;My Document&quot;
format:
  docx:
    toc: true
---

# Section name

&lt;div class=&quot;figure&quot;&gt;
&lt;img src=&quot;R_files/figure-html/fig-plot-1.png&quot; alt=&quot;Plot&quot; width=&quot;672&quot; /&gt;
&lt;p class=&quot;caption&quot;&gt;Plot&lt;/p&gt;
&lt;/div&gt;

For example, see @fig-plot.</code></pre>
<p>Render with:</p>
<pre><code>quarto render document.qmd</code></pre>
<p>Create a template:</p>
<pre><code>quarto pandoc -o custom-reference-doc.docx \
   --print-default-data-file reference.docx</code></pre>
<p>Other notes:</p>
<ul>
<li>The redoc package was developped in 2019, but abandoned. <a
href="https://bookdown.org/yihui/rmarkdown-cookbook/word-redoc.html"
class="uri">https://bookdown.org/yihui/rmarkdown-cookbook/word-redoc.html</a></li>
</ul>
</div>
</div>
<div id="python-engine" class="section level2">
<h2>Python engine</h2>
<p>Rstudio: <a
href="https://rstudio.github.io/reticulate/articles/r_markdown.html">R
Mardown python engine</a></p>
<p>See also the reticulate package mentioned below.</p>
<div id="reticulate-to-call-python-from-r" class="section level3">
<h3>Reticulate to call python from R</h3>
<p>Example of a python chunk followed by an R chunk.</p>
<pre><code># ---
# title: &quot;The Ultimate Question&quot;
# ---

# ```{r setup}
# library(reticulate)
# ```

# ```{python}
# import pandas
# df = pandas.DataFrame({&#39;x&#39;:[2,3,7], &#39;y&#39;:[&#39;life&#39;,&#39;universe&#39;,&#39;everything&#39;]})
# ```

# ```{r}
# str(py$df)
# prod(py$df$x)
# ```</code></pre>
<p>More information in the vignette:</p>
<pre><code>vignette(&quot;calling_python&quot;, package=&quot;reticulate&quot;)</code></pre>
<p>This can also be used to call python functions in R</p>
<pre><code>λ{python eval=FALSE}
from biotrade.faostat import faostat
—


```r
soy_prod &lt;- py$faostat$db$select(table=&quot;crop_production&quot;, product = &quot;soy&quot;)
```</code></pre>
</div>
<div id="using-reticulate-in-an-r-packages" class="section level3">
<h3>Using Reticulate in an R packages</h3>
<blockquote>
<p>“When you do this, you should use the delay_load flag to the import()
function, for example:”</p>
</blockquote>
<pre><code># global reference to scipy (will be initialized in .onLoad)
scipy &lt;- NULL

.onLoad &lt;- function(libname, pkgname) {
  # use superassignment to update global reference to scipy
  scipy &lt;&lt;- reticulate::import(&quot;scipy&quot;, delay_load = TRUE)
}</code></pre>
<blockquote>
<p>“Using the delay_load flag has two important benefits:”</p>
</blockquote>
<blockquote>
<p>“It allows you to successfully load your package even when Python /
Python packages are not installed on the target system (this is
particularly important when testing on CRAN build machines).”</p>
</blockquote>
<blockquote>
<p>“It allows users to specify a desired location for Python before
interacting with your package.”</p>
</blockquote>
<div id="example-r-packages-that-use-reticulate" class="section level4">
<h4>Example R packages that use reticulate</h4>
<ul>
<li>spicyr <a
href="https://cran.r-project.org/web/packages/spacyr/index.html"
class="uri">https://cran.r-project.org/web/packages/spacyr/index.html</a>
<ul>
<li>Vignette <a
href="https://cran.r-project.org/web/packages/spacyr/vignettes/using_spacyr.html"
class="uri">https://cran.r-project.org/web/packages/spacyr/vignettes/using_spacyr.html</a></li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="reproducibility-and-cloud-computing" class="section level1">
<h1>Reproducibility and cloud computing</h1>
<div id="cloudyr-project" class="section level2">
<h2>Cloudyr project</h2>
<p>The <a href="https://cloudyr.github.io/packages/index.html">cloudyr
project</a> is a collection of R packages to enable cloud computing.</p>
<p>R packages that are actively maintained can be seen on the <a
href="https://github.com/cloudyr">github project page of
cloudyr</a>.</p>
<ul>
<li><p>For example the <a
href="https://github.com/cloudyr/googleCloudVisionR">googleCloudVisionR</a>
package gets the following image annotations for a picture of golden
retriever puppies</p>
<pre><code>    description     score topicality
            Dog 0.9953705  0.9953705
         Mammal 0.9890478  0.9890478
     Vertebrate 0.9851104  0.9851104
        Canidae 0.9813780  0.9813780
      Dog breed 0.9683250  0.9683250
          Puppy 0.9400384  0.9400384</code></pre>
<p>Golden retriever 0.8966703 0.8966703</p></li>
</ul>
</div>
<div id="rocker" class="section level2">
<h2>Rocker</h2>
<p><a href="https://github.com/rocker-org/rocker">rocker-org/rocker</a>
provides a series of docker images for various R development
purposes.</p>
<p>Bioconductor <a
href="https://www.bioconductor.org/help/docker/#intro">docker
intro</a></p>
<blockquote>
<p>“With Bioconductor containers, we hope to enhance Reproducibility: If
you run some code in a container today, you can run it again in the same
container (with the same tag) years later and know that nothing in the
container has changed. You should always take note of the tag you used
if you think you might want to reproduce some work later.”</p>
</blockquote>
</div>
</div>
<div id="rscript" class="section level1">
<h1>Rscript</h1>
<p>Capture arguments in an Rscript on windows and write them to a
file</p>
<pre><code>&quot;C:\Program Files\R\R-3.5.0\bin\Rscript.exe&quot; --verbose -e &quot;args = commandArgs(trailingOnly=TRUE)&quot; -e &quot;writeLines(args,&#39;C:\\Dev\\args.txt&#39;)&quot; &quot;file1.csv&quot; &quot;file2.csv&quot; &quot;file3.csv&quot;</code></pre>
<p>Arguments can be extracted one by one with args[1] commandArgs()
returns a <strong>character vector</strong> containing the name of the
executable and the user-supplied command line arguments.</p>
<div id="set-knitr-options" class="section level2">
<h2>Set knitr options</h2>
<p>Those 2 commands are different. Sets the options for chunk, within a
knitr chunk inside the .Rmd document</p>
<pre><code>opts_chunk$set(fig.width=10)</code></pre>
<p>Sets the options for knitr outside the .Rmd document</p>
<pre><code>opts_knit$set()</code></pre>
</div>
</div>
<div id="manipulate-vectors" class="section level1">
<h1>Manipulate vectors</h1>
<div id="cut-and-split" class="section level2">
<h2>Cut and split</h2>
<p>Cut a vector in smaller components</p>
<pre><code>cut(0:16, 4)</code></pre>
</div>
<div id="combine-vectors" class="section level2">
<h2>Combine vectors</h2>
<p>Combine vectors with c()</p>
<pre><code>x &lt;- c(1, 2, 3)
y &lt;- c(4, 5)
c(x, y)</code></pre>
<p>Unite multiple columns into one by pasting strings together</p>
<pre><code>df &lt;- expand_grid(x = c(&quot;a&quot;, NA), y = c(&quot;b&quot;, NA))
df

df %&gt;% unite(&quot;z&quot;, x:y, remove = FALSE)
# To remove missing values:
df %&gt;% unite(&quot;z&quot;, x:y, na.rm = TRUE, remove = FALSE)

# Separate is almost the complement of unite
df %&gt;%
  unite(&quot;xy&quot;, x:y) %&gt;%
  separate(xy, c(&quot;x&quot;, &quot;y&quot;))
# (but note `x` and `y` contain now &quot;NA&quot; not NA)</code></pre>
</div>
</div>
<div id="maps" class="section level1">
<h1>Maps</h1>
<div id="choropleth-maps" class="section level2">
<h2>Choropleth maps</h2>
<ul>
<li><p><a
href="https://www.r-graph-gallery.com/choropleth-map.html">Choropleth
map</a></p></li>
<li><p>Shape files to make choropleth maps of Europe: <a
href="https://ec.europa.eu/eurostat/web/gisco/geodata/reference-data/administrative-units-statistical-units/nuts">GISCO:
Geographical Information and maps</a></p></li>
<li><p><a
href="https://ropengov.github.io/eurostat/articles/maps.html">Map
example of the eurostat R package</a></p></li>
<li><p><a href="https://ropengov.github.io/giscoR/">Gisco R</a> related
to the above Eurostat package</p></li>
</ul>
<p>Other potentially interesting packages:</p>
<ul>
<li><a
href="https://cran.r-project.org/web/packages/googleway/index.html">Googleway</a></li>
</ul>
</div>
</div>
<div id="packages" class="section level1">
<h1>Packages</h1>
<p>You might want to read the CRAN manual on <a
href="https://cran.r-project.org/doc/manuals/R-exts.html">Writing R
Extensions</a>, and its section on <a
href="https://cran.r-project.org/doc/manuals/R-exts.html#Package-Dependencies">Package
dependencies</a>. See also Hadley’s book on R package and its section on
<a href="http://r-pkgs.had.co.nz/namespace.html">Namespace</a></p>
<p>Use the devtools library to start a package folder structure:</p>
<pre><code>devtools::create(&quot;package_name&quot;)</code></pre>
<p>Use git to track code modifications (shell commands):</p>
<pre><code>$ cd package_name
$ git init</code></pre>
<div id="documentation" class="section level2">
<h2>Documentation</h2>
<p>The roxygen2 package helps with function documentation. Documentation
can be written in the form of comments #’ tags such as
<code>@param</code> and <code>@description</code> structure the
documentation of each function.</p>
<p>For an introcution to roxygen2, call
<code>vignette("roxygen2", package = "roxygen2")</code> at the R
prompt.</p>
<p>Since roxygen2 version 6, markdown formating can be used in the
documentation, by specifying the <code>@md</code> tag.</p>
<div id="examples" class="section level3">
<h3>Examples</h3>
<p>Examples are crucial to demonstrate the use of a fonction. They can
be specified in a roxygen block called <code>@examples</code>:</p>
<pre><code>#&#39; @examples</code></pre>
<p>Wrap the examples in donttest if you don’t want R CMD check to test
them at package building time.</p>
<pre><code>#&#39; \donttest{d</code></pre>
<p>It is also possible to wrap them in another statement called
<code>dontrun</code>, but this is not recomended on CRAN according to
this <a
href="https://stackoverflow.com/a/44997778/2641825">Stackoverflow
question</a>.</p>
</div>
<div id="vignettes" class="section level3">
<h3>Vignettes</h3>
<p><a href="http://r-pkgs.had.co.nz/vignettes.html">Vignettes: long-form
documentation</a></p>
<pre><code>devtools::use_vignette(&quot;my-vignette&quot;)</code></pre>
<p><a
href="https://stackoverflow.com/questions/12325223/where-to-put-package-vignettes-for-cran-submission">Where
to put package vignettes for CRAN submission</a></p>
<blockquote>
<p>“You put the .Rnw sources in vignettes/ as you did, but you missed
out a critical step; don’t check the source tree. The expected workflow
is to build the source tarball and then check that tarball. Building the
tarball will create the vignette PDF.”</p>
</blockquote>
<pre><code>R CMD build ../foo/pkg
R CMD check ./pkg-0.4.tar.gz</code></pre>
<p>Issues while building vignette for a packages:</p>
<ul>
<li><p>sh: 1: /usr/bin/texi2dvi: not found</p>
<p>sudo apt-get install texinfo</p></li>
<li><p><a
href="https://github.com/clonghurst/Res.plotter/issues/3">Warning about
“vignette without corresponding PDF/HTML”?</a></p></li>
</ul>
<blockquote>
<p>“Maybe you’re running R CMD check using the directory name rather
than the .tar.gz file?”</p>
</blockquote>
<ul>
<li><a
href="https://stackoverflow.com/questions/34524357/inconsolata-missing-to-build-r-vignette">Inconsolata
missing to build R vignette</a></li>
</ul>
<blockquote>
<p>“Installing texlive-fonts-extra should take care of it.”</p>
</blockquote>
<p>R CMD checking data for non-ASCII characters found 179 marked UTF-8
strings No solution for this one but I guess it’s ok since it concerns
country names?</p>
</div>
</div>
<div id="unit-tests" class="section level2">
<h2>Unit tests</h2>
<p>Back in R, add testing infrastructure:</p>
<pre><code>devtools::use_testthat()</code></pre>
<p>When checking the package with R CMD CHECK, <a
href="https://stackoverflow.com/questions/9439256/how-can-i-handle-r-cmd-check-no-visible-binding-for-global-variable-notes-when">How
can I handle R CMD check “no visible binding for global variable”?</a>
These notes are caused by variables used with dplyr verbs and ggplot2
aesthetics.</p>
</div>
<div id="continuous-integration" class="section level2">
<h2>Continuous Integration</h2>
<p>It is good to know if your package can be installed on a fresh
system. Continuous integration systems make this possible each time you
submit a modification to your repository.</p>
<p>I have used travis-ci which is free for open github repositories. <a
href="https://docs.travis-ci.com/user/languages/r/">Instructions to
build an R project on travis</a>. Unit tests are also run on travis, in
addition to R CMD CHECK. Package dependencies can be configured in a
<code>.travis.yml</code> file that is read by the travis machine
performing the build. For package that are not on Cran, it’s possible to
specify a dependency field under <code>r_github_packages</code>.</p>
<p>In 2020 RopenSci moved away from Travis CI because of a change of
mannagement which removed support for open source projects. In <a
href="https://ropensci.org/blog/2020/11/19/moving-away-travis/">this
post</a> Jeroen Ooms thanks Travis CI for greatly enabling CI since
2012.</p>
</div>
<div id="make-file" class="section level2">
<h2>Make file</h2>
<ul>
<li>kbroman <a href="https://kbroman.org/minimal_make/">minimal
make</a></li>
<li>Cran <a
href="https://stackoverflow.com/questions/46741739/how-to-use-makefiles-with-r-cmd-build">how
to use make files with R CMD build</a></li>
</ul>
<p>I copied the make file from the knitr package.</p>
</div>
<div id="submitting-to-cran" class="section level2">
<h2>Submitting to CRAN</h2>
<p><a href="https://cran.r-project.org/submit.html">Submit package to
CRAN</a> The second page will ask to</p>
<ul>
<li>Step 1 (Upload) the <code>*.tar.gz</code> file.</li>
<li>Step 2 (Submission) review information from the package’s
DESCRIPTION file.</li>
<li>Step 3 (Confirmation)</li>
</ul>
<p>The maintainer of this package has been sent an email to confirm the
submission. After their confirmation the package will be passed to CRAN
for review.</p>
<p>In general enter the Git tag after the submission has been completed,
because it is very likely that additional information will need to be
added to the package before or during the submission process.</p>
<div id="crans-automated-check-of-urls-validity" class="section level3">
<h3>CRAN’s automated check of URL’s validity</h3>
<p>Upon submission CRAN runs an automated check of URL validity. This <a
href="https://blog.r-hub.io/2020/12/01/url-checks/">blog post</a>
explains that URLS in vignettes and function documentations are
checked.</p>
</div>
<div id="is-it-possible-to-rename-a-package-on-cran"
class="section level3">
<h3>Is it possible to rename a package on CRAN</h3>
<p><a
href="https://stat.ethz.ch/pipermail/r-devel/2013-August/067264.html">Uwe
Ligges on the R-devel mailing list</a>:</p>
<blockquote>
<p>“Renaming packages should be reduced to an absolute minimum and would
probably only accepted for legal concerns related to inappropriate
package names.”</p>
</blockquote>
<p><a
href="https://stackoverflow.com/questions/22654421/how-to-rename-an-existing-r-package-on-cran">Related
SO question</a></p>
</div>
</div>
</div>
<div id="plots" class="section level1">
<h1>Plots</h1>
<ul>
<li>R graph gallery <a href="https://r-graph-gallery.com/"
class="uri">https://r-graph-gallery.com/</a></li>
</ul>
<div id="plotting-with-ggplot2" class="section level2">
<h2>Plotting with ggplot2</h2>
<pre><code>geom_bar
geom_tile + a gradient produce heat maps</code></pre>
<div id="ab-lines" class="section level3">
<h3>AB lines</h3>
<p>Plot a line with a slope of 1, y=x</p>
<pre><code>library(ggplot2)
ggplot() +
    geom_abline(slope=1)</code></pre>
<p><a
href="http://www.sthda.com/english/wiki/ggplot2-add-straight-lines-to-a-plot-horizontal-vertical-and-regression-lines">Plot
a linear regression line</a></p>
<pre><code>library(stats)
library(ggplot2)
reg &lt;- lm(mpg ~ wt, data = mtcars)
coeff=coefficients(reg)
# Equation of the line :
eq = paste0(&quot;y = &quot;, round(coeff[2],1), &quot;*x + &quot;, round(coeff[1],1))
# Plot
sp &lt;- ggplot(data=mtcars, aes(x=wt, y=mpg)) + geom_point()
sp + geom_abline(intercept = 37, slope = -5)+
  ggtitle(eq)</code></pre>
</div>
<div id="axes-scales" class="section level3">
<h3>Axes, scales</h3>
<p>Increase number of axis ticks by specifying an integer break
vector</p>
<pre><code>scale_x_continuous(breaks = 1:10)</code></pre>
<div id="rotate-the-tick-text" class="section level4">
<h4>Rotate the tick text</h4>
<p>Rotate the tick text of the X axis. SO question <a
href="https://stackoverflow.com/questions/1330989/rotating-and-spacing-axis-labels-in-ggplot2">rotating
axis labels in ggplot2</a></p>
<pre><code>theme(axis.text.x=element_text(angle = 90, hjust=0))</code></pre>
</div>
<div id="dates-1" class="section level4">
<h4>Dates</h4>
<p>When dates are on the x axis, use a time scale and specify the breaks
as a time vector</p>
<pre><code>scale_x_date(breaks = lubridate::parse_date_time(2000:2020, &quot;%y&quot;))</code></pre>
<p>Alternatively breaks can be specified as an interval, and minor
breaks as well</p>
<pre><code>scale_x_datetime(date_breaks = &quot;5 years&quot;, labels = scales::date_format(&quot;%Y&quot;), date_minor_breaks = &quot;1 year&quot;)</code></pre>
</div>
<div id="percentages" class="section level4">
<h4>Percentages</h4>
<p>To display shares as percentages, use
<code>scales::percent</code></p>
<pre><code>scale_y_continuous(labels = scales::percent)</code></pre>
</div>
</div>
<div id="legend" class="section level3">
<h3>Legend</h3>
<p>Place the legend below a plot:</p>
<pre><code>library(ggplot2)
ggplot(iris, aes(Petal.Width, Sepal.Width, color=Species)) + 
    geom_point() + 
    theme(legend.position=&quot;bottom&quot;)</code></pre>
<p>Remove the legend</p>
<pre><code>ggplot(iris, aes(Petal.Width, Sepal.Width, color=Species)) + 
    geom_point() + 
    theme(legend.position=&quot;none&quot;)</code></pre>
<p><a
href="https://stackoverflow.com/questions/14604435/turning-off-some-legends-in-a-ggplot">Remove
only part of the legend</a></p>
<pre><code>guides(colour = &quot;none&quot;)</code></pre>
<p>Change the name of a particular sub element in the legend:</p>
<pre><code>labs(color=&quot;Iris Species&quot;)
labs(linetype=&quot;Sawnwood product group&quot;)
labs(y=&quot;million&quot;)</code></pre>
<p>Make a multi column legend</p>
<pre><code>library(scales)

plot + # With a fill aeasthetic
    guides(fill=guide_legend(ncol = 2))

plot + # with a color aesthetic 
     guides(col = guide_legend(ncol = 1))</code></pre>
<p>See ggplot2 reference <a
href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide
legend</a>.</p>
<div id="change-the-order-of-legend-items" class="section level4">
<h4>Change the order of legend items</h4>
<p><a href="https://www.statology.org/ggplot-legend-order/">Reorder
items in the fill legend</a>:</p>
<pre><code>library(ggplot2)
ggplot(iris, aes(x=Species, y=Petal.Width, fill=Species)) +
  geom_boxplot() +
  scale_fill_discrete(breaks= c(&quot;virginica&quot;, &quot;setosa&quot;, &quot;versicolor&quot;))</code></pre>
</div>
<div id="one-legend-for-each-sub-plot" class="section level4">
<h4>One legend for each sub plot</h4>
<p><a href="https://stackoverflow.com/a/14841379/2641825">Different
legends for each sub plot using grid extra</a></p>
<pre><code>library(ggplot2)
library(gridExtra)
df &lt;- data.frame(country = rep(c(&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;), each=9),
                 product = rep(c(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;B&quot;, &quot;D&quot;, &quot;A&quot;),each=3),
                 year = rep(1:3,9),
                 value = rnorm(27)
)
out &lt;- by(data = df,                                                  
          INDICES = df$product,
          FUN = function(m) {                                                     
              ggplot(m, aes(x=year, y=value, color=country)) +
                  geom_point() +
                  facet_wrap(~product, scales=&quot;free_y&quot;) +                    
                  theme_minimal()                                                 
          })                                                                      
do.call(grid.arrange, out)                                                        
# If you want to supply the parameters to grid.arrange
#do.call(grid.arrange, c(out, ncol=3))</code></pre>
<p>Different legend for each sub plot using patchwork</p>
</div>
</div>
<div id="math-formulas-in-facet-labels" class="section level3">
<h3>Math formulas in facet labels</h3>
<p>Note to add a new line to a facet label, simply insert it with</p>
<pre><code>facet_variable = gsub(&quot; &quot;,&quot;\n&quot;, facet_variable)</code></pre>
<pre class="r"><code>library(dplyr)
library(ggplot2)

# Create a first facet variable with examples of math formulas
iris2 &lt;- iris %&gt;%
    mutate(species_math = factor(Species,
                            levels = c(&quot;setosa&quot;, &quot;versicolor&quot;, &quot;virginica&quot;),
                            labels = c(&quot;m^2&quot;,
                                       expression(bar(x) == sum(frac(x[i], n), i==1, n) * beta * Q[t-1]),
                                       bquote(pi == .(pi)))))

# Create a second facet variable with mean lengths
# This illustrates how to pass a numeric vector inside a formula
iris_mean &lt;- iris2 %&gt;%
    group_by(Species) %&gt;%
    summarise(across(ends_with(&quot;Length&quot;), mean), .groups=&quot;drop&quot;)

iris2$mean_length &lt;- factor(iris2$Species,
                           levels =  c(&quot;setosa&quot;, &quot;versicolor&quot;, &quot;virginica&quot;),
                           labels = mapply(function(p, s) bquote(bar(p) == .(p) ~ bar(s) ==.(s)),
                                            round(iris_mean$Petal.Length,3), round(iris_mean$Sepal.Length,3)))

# Create the faceted plot
iris2 %&gt;%
    ggplot(aes(x = Petal.Length, y = Petal.Width)) +
    geom_point() +
    facet_wrap(species_math ~ mean_length + Species,
               labeller = labeller(species_math = label_parsed, mean_length = label_parsed))</code></pre>
<p><img src="R_files/figure-html/math_in_facet_labels-1.png" width="672" /></p>
<p>As shown in the example above, the labeller can parse:</p>
<ol style="list-style-type: decimal">
<li><p>A character vector such as “m^2” for simple formulas</p></li>
<li><p>An <code>expression</code> for more complex math with
indices</p></li>
<li><p>The output of <code>bquote</code> to include numerical values in
the formula. See also <a
href="https://stackoverflow.com/a/58048944/2641825">this answer</a> on
how to use <code>bquote</code> with numerical vectors of more than one
value.</p></li>
<li><p>see <a href="https://stackoverflow.com/a/51863090/2641825">this
other answer</a> on how to apply the labeller to one of the faceting
variables only. In our case we apply it to the <code>species_math</code>
variable only.</p></li>
</ol>
<p>The syntax is different from Latex math formulas because
<code>label_parsed</code> interprets labels as <code>plotmath</code>
expressions. For example indices are written <code>x_i</code> in Latex
and <code>x[i]</code> in plot math expressions, and Greek letters are
written directly as <code>alpha</code> instead of <code>\alpha</code> in
Latex. You can find many formulas in the help page of the <a
href="https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/plotmath.html">plotmath</a>
function. Good luck with the <code>plotmath</code> examples.</p>
</div>
<div id="save-plots-to-pdf" class="section level3">
<h3>Save plots to pdf</h3>
<p>Use <a
href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a>:</p>
<pre><code>ggplot(mtcars, aes(mpg, wt)) + geom_point()
ggsave(&quot;mtcars.pdf&quot;)</code></pre>
</div>
<div id="themes" class="section level3">
<h3>Themes</h3>
<p>Minimal theme</p>
<pre><code>theme_minimal()</code></pre>
</div>
</div>
<div id="geoms" class="section level2">
<h2>Geoms</h2>
<div id="bar-plots-with-geom_col" class="section level3">
<h3>Bar plots with geom_col</h3>
<p>Use geom_col for bar plots where the height of the column represent
the value of a variable. Use geom_bar for plots where the height of the
column represents a count of number of occurrences.</p>
</div>
<div id="geom_ribbon" class="section level3">
<h3>geom_ribbon</h3>
<p>Example from help(geom_ribbon):</p>
<pre><code> huron &lt;- data.frame(year = 1875:1972, level = as.vector(LakeHuron))
 ggplot(huron, aes(year)) +
   geom_ribbon(aes(ymin = level - 1, ymax = level + 1), fill = &quot;grey70&quot;) +
   geom_line(aes(y = level))</code></pre>
<p><a
href="https://stackoverflow.com/questions/7755041/ggplot-remove-lines-at-ribbon-edges">Add
or remove lines at the border of the ribbon</a>:</p>
<pre><code> ggplot(huron, aes(year)) +
   geom_ribbon(aes(ymin = level - 1, ymax = level + 1), 
               outline.type=&quot;lower&quot;, fill = &quot;grey70&quot;, color=&quot;red&quot;) +
   geom_line(aes(y = level))

 ggplot(huron, aes(year)) +
   geom_ribbon(aes(ymin = level - 1, ymax = level + 1), 
               outline.type=&quot;lower&quot;, fill = &quot;grey70&quot;, color=&quot;red&quot;,
               linetype=0) +
   geom_line(aes(y = level))</code></pre>
</div>
</div>
<div id="palettes" class="section level2">
<h2>Palettes</h2>
<p><a
href="https://data.library.virginia.edu/setting-up-color-palettes-in-r/">Setting
up colour palettes in R</a></p>
<blockquote>
<p>To create a RColorBrewer palette, use the brewer.pal function. It
takes two arguments: n, the number of colors in the palette; and name,
the name of the palette. Let’s make a palette of 8 colors from the
qualitative palette, “Set2”.</p>
</blockquote>
<pre><code>library(RColorBrewer)
brewer.pal(n = 8, name = &quot;Set2&quot;) 
#[1] &quot;#66C2A5&quot; &quot;#FC8D62&quot; &quot;#8DA0CB&quot; &quot;#E78AC3&quot; &quot;#A6D854&quot; &quot;#FFD92F&quot; &quot;#E5C494&quot; &quot;#B3B3B3&quot; 
palette(brewer.pal(n = 8, name = &quot;Set2&quot;))</code></pre>
<p>Use this palette in ggplot2</p>
<pre><code>ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Species)) + 
    geom_point() +
    scale_color_brewer(palette = &quot;Set2&quot;)</code></pre>
<div id="manual-colours" class="section level3">
<h3>Manual colours</h3>
<p>Use a named vector to set a palette in ggplot2 as explained in <a
href="https://ggplot2.tidyverse.org/reference/scale_manual.html">ggplot2
scale_manual</a></p>
<pre><code>p &lt;- ggplot(iris, aes(x=Sepal.Length, y=Petal.Length, color=Species)) +
        geom_point() 
p + scale_colour_manual(values = c(setosa=&#39;black&#39;, versicolor=&#39;red&#39;, virginica=&#39;green&#39;))</code></pre>
<p>Create a named palette using R colour brewer:</p>
<pre><code>species_names &lt;- c(&quot;setosa&quot;, &quot;versicolor&quot;, &quot;virginica&quot;) 
iris_palette &lt;- setNames(brewer.pal(n=length(species_names), name=&#39;Set2&#39;), 
                         species_names)
p + scale_colour_manual(values = iris_palette)</code></pre>
</div>
<div id="display-palettes" class="section level3">
<h3>Display palettes</h3>
<p>Display qualitative palettes:</p>
<pre><code>display.brewer.all(type=&quot;qual&quot;) </code></pre>
<p>Display all palettes</p>
<pre><code>display.brewer.all()</code></pre>
</div>
<div id="add-more-colours-to-a-palette" class="section level3">
<h3>Add more colours to a palette</h3>
<p><a
href="https://www.datanovia.com/en/blog/easy-way-to-expand-color-palettes-in-r/">Expand
colour palettes in R</a></p>
<p>Expand from 8 colours to more colours:</p>
<pre><code>mycolors &lt;- colorRampPalette(brewer.pal(8, &quot;Set2&quot;))(nb.cols)</code></pre>
</div>
</div>
<div id="text-labels" class="section level2">
<h2>Text labels</h2>
<p>ggplot2 <a
href="https://ggplot2.tidyverse.org/reference/geom_text.html">text</a></p>
<p>Use position jitter</p>
<pre class="r"><code>#  Reduce the number of points so it becomes more readable
iris2 &lt;- iris %&gt;% 
    group_by(Species, Petal.Width) %&gt;%
    summarise(Sepal.Width = mean(Sepal.Width))
ggplot(iris2, aes(x = Petal.Width, y=Sepal.Width, color = Species)) +
    geom_text(aes(label = Species), 
              position=position_jitter(width=0.5,height=0.3),
              hjust=&quot;left&quot;) +
    # Expand the scale so that names are shown in full
    scale_x_continuous(expand = expansion(mult=c(0.1,0.5)))</code></pre>
<p>Use repulsive textual annotations</p>
<pre class="r"><code>ggplot(iris2, aes(x = Petal.Width, y=Sepal.Width, color = Species)) +
    ggrepel::geom_text_repel(aes(label = Species))</code></pre>
<p>Change the text size</p>
<pre class="r"><code>ggplot(iris2, aes(x = Petal.Width, y=Sepal.Width, color = Species)) +
    ggrepel::geom_text_repel(aes(label = Species), size=8)</code></pre>
<p><a href="https://ggrepel.slowkow.com/articles/examples.html">More
ggrepel examples</a></p>
<p>Justification</p>
<pre class="r"><code>df &lt;- data.frame(
  x = c(1, 1, 2, 2, 1.5),
  y = c(1, 2, 1, 2, 1.5),
  text = c(&quot;bottom-left&quot;, &quot;bottom-right&quot;, &quot;top-left&quot;, &quot;top-right&quot;, &quot;center&quot;)
)
ggplot(df, aes(x, y)) +
  geom_text(aes(label = text))
ggplot(df, aes(x, y)) +
  geom_text(aes(label = text), vjust = &quot;inward&quot;, hjust = &quot;inward&quot;)</code></pre>
</div>
</div>
<div id="python-compared-to-r" class="section level1">
<h1>Python compared to R</h1>
<p>See also the <a href="python.html">python</a> page for a comparison
between pandas methods and R data frames functions.</p>
<pre><code>l = c(1,2,3)
s = l
s[3]
[1] 3
s[3] = &quot;a&quot;
s
[1] &quot;1&quot; &quot;2&quot; &quot;a&quot;
l
[1] 1 2 3</code></pre>
<p>Using the address function to see the address of these objects in
memory We can see that s and l share the same address. The address only
changes when we asign something to s.</p>
<pre><code>library(pryr)
l = c(1,2,3)
s = l
address(l)
[1] &quot;0x316f718&quot;
address(s)
[1] &quot;0x316f718&quot;
s[3] = &quot;a&quot;
address(s)
[1] &quot;0x36a7d30&quot;
s
[1] &quot;1&quot; &quot;2&quot; &quot;a&quot;
l
[1] 1 2 3</code></pre>
<p>Checking string objects</p>
<pre><code>bla = &quot;qsdfmlkj&quot;
address(bla)
[1] &quot;0x38e5120&quot;
bli = bla
address(bli)
[1] &quot;0x38e5120&quot;
bli = paste(bli, &quot;sdf&quot;)
address(bli)
[1] &quot;0x38d1d60&quot;</code></pre>
<p>TODO Compare to the same code in python to see the difference between
the above and passing by reference.</p>
</div>
<div id="shiny" class="section level1">
<h1>Shiny</h1>
<p><a href="https://shiny.rstudio.com/gallery/kmeans-example.html">K
means example</a></p>
<div id="app.r" class="section level2">
<h2>App.R</h2>
<p><a
href="https://shiny.rstudio.com/tutorial/written-tutorial/lesson1/">Shiny
tutorial lesson 1</a></p>
<blockquote>
<p>“Note: Prior to version 0.10.2, Shiny did not support single-file
apps and the ui object and server function needed to be contained in
separate scripts called ui.R and server.R, respectively. This
functionality is still supported in Shiny, however the tutorial and much
of the supporting documentation focus on single-file apps.”</p>
</blockquote>
</div>
</div>
<div id="tidyverse" class="section level1">
<h1>Tidyverse</h1>
<div id="dplyr" class="section level2">
<h2>dplyr</h2>
<div id="group_by-and-summarise" class="section level3">
<h3>Group_by and summarise</h3>
<pre class="r"><code>library(dplyr)
cars %&gt;%
    group_by(speed) %&gt;%
    print(n=2) %&gt;% # works because the print function returns its argument
    summarise(numberofcars = n(),
              min = min(dist),
              mean = mean(dist),
              max = max(dist)) </code></pre>
<pre><code>## # A tibble: 50 × 2
## # Groups:   speed [19]
##   speed  dist
##   &lt;dbl&gt; &lt;dbl&gt;
## 1     4     2
## 2     4    10
## # ℹ 48 more rows</code></pre>
<pre><code>## # A tibble: 19 × 5
##    speed numberofcars   min  mean   max
##    &lt;dbl&gt;        &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1     4            2     2   6      10
##  2     7            2     4  13      22
##  3     8            1    16  16      16
##  4     9            1    10  10      10
##  5    10            3    18  26      34
##  6    11            2    17  22.5    28
##  7    12            4    14  21.5    28
##  8    13            4    26  35      46
##  9    14            4    26  50.5    80
## 10    15            3    20  33.3    54
## 11    16            2    32  36      40
## 12    17            3    32  40.7    50
## 13    18            4    42  64.5    84
## 14    19            3    36  50      68
## 15    20            5    32  50.4    64
## 16    22            1    66  66      66
## 17    23            1    54  54      54
## 18    24            4    70  93.8   120
## 19    25            1    85  85      85</code></pre>
<p>group_by() creates a tbl_df objects which is a wrapper around a
data.frame to enable some functionalities. Note that print returns its
output on a tbl_df object. So print() can be used inside the pipe
without stopping the workflow.</p>
<div id="count-and-tally" class="section level4">
<h4>Count and tally</h4>
<p>Count the unique values of one or more variables</p>
<pre><code>count(iris, Species, sort=TRUE)</code></pre>
<p>is equivalent to</p>
<pre><code>iris %&gt;%
    group_by(Species) %&gt;%
    tally(sort=TRUE)</code></pre>
<p>The <code>wt</code> argument can be used to perform weighted
counts</p>
<pre><code>count(iris, Species, wt=Sepal.Length, sort=TRUE)</code></pre>
</div>
</div>
<div id="across" class="section level3">
<h3>Across</h3>
<p>Apply the same transformation to multiple columns, allowing to use
select semantics inside summarise and mutate.</p>
<pre class="r"><code>cars %&gt;%
    group_by(speed) %&gt;%
    summarise(across(dist, list(n = length , min = min, mean = mean, max = max)))</code></pre>
<pre><code>## # A tibble: 19 × 5
##    speed dist_n dist_min dist_mean dist_max
##    &lt;dbl&gt;  &lt;int&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
##  1     4      2        2       6         10
##  2     7      2        4      13         22
##  3     8      1       16      16         16
##  4     9      1       10      10         10
##  5    10      3       18      26         34
##  6    11      2       17      22.5       28
##  7    12      4       14      21.5       28
##  8    13      4       26      35         46
##  9    14      4       26      50.5       80
## 10    15      3       20      33.3       54
## 11    16      2       32      36         40
## 12    17      3       32      40.7       50
## 13    18      4       42      64.5       84
## 14    19      3       36      50         68
## 15    20      5       32      50.4       64
## 16    22      1       66      66         66
## 17    23      1       54      54         54
## 18    24      4       70      93.8      120
## 19    25      1       85      85         85</code></pre>
<p>With trade data</p>
<pre class="r"><code>summarise(across(all_of(c(&quot;tradevalue&quot;, &quot;weight&quot;, &quot;quantity&quot;)), sum, na.rm=TRUE))</code></pre>
<p>Other examples from the help of the across function</p>
<pre class="r"><code># A purrr-style formula
iris %&gt;%
    group_by(Species) %&gt;%
    summarise(across(starts_with(&quot;Sepal&quot;), ~mean(.x, na.rm = TRUE)))</code></pre>
<pre><code>## # A tibble: 3 × 3
##   Species    Sepal.Length Sepal.Width
##   &lt;fct&gt;             &lt;dbl&gt;       &lt;dbl&gt;
## 1 setosa             5.01        3.43
## 2 versicolor         5.94        2.77
## 3 virginica          6.59        2.97</code></pre>
<pre class="r"><code># A named list of functions
iris %&gt;%
    group_by(Species) %&gt;%              # 
    summarise(across(starts_with(&quot;Sepal&quot;), list(mean = mean, sd = sd)))</code></pre>
<pre><code>## # A tibble: 3 × 5
##   Species    Sepal.Length_mean Sepal.Length_sd Sepal.Width_mean Sepal.Width_sd
##   &lt;fct&gt;                  &lt;dbl&gt;           &lt;dbl&gt;            &lt;dbl&gt;          &lt;dbl&gt;
## 1 setosa                  5.01           0.352             3.43          0.379
## 2 versicolor              5.94           0.516             2.77          0.314
## 3 virginica               6.59           0.636             2.97          0.322</code></pre>
<pre class="r"><code># Show all_of to select a vector of variables
iris %&gt;%
    group_by(Species) %&gt;%
    summarise(across(all_of(c(&quot;Sepal.Length&quot;, &quot;Petal.Width&quot;)), 
                            ~mean(.x, na.rm = TRUE)))</code></pre>
<pre><code>## # A tibble: 3 × 3
##   Species    Sepal.Length Petal.Width
##   &lt;fct&gt;             &lt;dbl&gt;       &lt;dbl&gt;
## 1 setosa             5.01       0.246
## 2 versicolor         5.94       1.33 
## 3 virginica          6.59       2.03</code></pre>
<p>More information in the vignette</p>
<pre><code>vignette(&quot;colwise&quot;, package=&quot;dplyr&quot;)</code></pre>
<p>The vignette mentions this about <code>rename</code>:</p>
<blockquote>
<p>“across() doesn’t work with select() or rename() because they already
use tidy select syntax; if you want to transform column names with a
function, you can use rename_with().”</p>
</blockquote>
</div>
<div id="mutate-to-create-a-new-vector" class="section level3">
<h3>Mutate to create a new vector</h3>
<p>Mutate multiple variables in the dataframe at once using the
<code>vars()</code> helper function to scope the mutation: Note
<code>mutate_at</code> has been superseded by the across function.</p>
<pre class="r"><code>iris %&gt;%
    mutate_at(vars(starts_with(&quot;Petal&quot;)), round) %&gt;%
    head()</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5            1           0  setosa
## 2          4.9         3.0            1           0  setosa
## 3          4.7         3.2            1           0  setosa
## 4          4.6         3.1            2           0  setosa
## 5          5.0         3.6            1           0  setosa
## 6          5.4         3.9            2           0  setosa</code></pre>
</div>
<div id="rename-columns" class="section level3">
<h3>Rename columns</h3>
<p><code>rename_with</code> from the <code>dplyr</code> package can use
either a function or a formula to rename a selection of columns given as
the <code>.cols</code> argument. For example passing the function name
<code>toupper</code> or <code>tolower</code>:</p>
<pre><code>library(dplyr)
rename_with(head(iris), toupper, starts_with(&quot;Petal&quot;))
rename_with(head(iris), tolower, starts_with(&quot;Petal&quot;))</code></pre>
<p>Is equivalent to passing the formula <code>~ toupper(.x)</code>:</p>
<pre><code>rename_with(head(iris), ~ toupper(.x), starts_with(&quot;Petal&quot;))</code></pre>
<p>To rename all columns, you can also use <code>set_names</code> from
the rlang package. We now use <code>paste0</code> as a renaming
function. <code>pasteO</code> takes 2 arguments, as a result there are
different ways to pass the second argument depending on whether we use a
function or a formula.</p>
<pre><code>rlang::set_names(head(iris), paste0, &quot;_hi&quot;)
rlang::set_names(head(iris), ~ paste0(.x, &quot;_hi&quot;))</code></pre>
<p>The same can be achieved with <code>rename_with</code> by passing the
data frame as first argument <code>.data</code>, the function as second
argument <code>.fn</code>, all columns as third argument
<code>.cols=everything()</code> and the function parameters as the
fourth argument <code>...</code>. Alternatively you can place the
second, third and fourth arguments in a formula given as the second
argument.</p>
<pre><code>rename_with(head(iris), paste0, everything(), &quot;_hi&quot;)
rename_with(head(iris), ~ paste0(.x, &quot;_hi&quot;))</code></pre>
<p><code>rename_with</code> only works with data frames.
<code>set_names</code> is more generic and can also perform vector
renaming</p>
<pre><code>rlang::set_names(1:4, c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;, &quot;d&quot;))</code></pre>
</div>
<div id="recode-values-in-a-vector" class="section level3">
<h3>Recode values in a vector</h3>
<blockquote>
<p>“Replace numeric values based on their position or their name, and
character or factor values only by their name.”</p>
</blockquote>
<pre><code>char_vec &lt;- sample(c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;), 10, replace = TRUE)
recode(char_vec, a = &quot;Apple&quot;)</code></pre>
</div>
</div>
<div id="pipes" class="section level2">
<h2>Pipes</h2>
</div>
<div id="purrr" class="section level2">
<h2>purrr</h2>
<p>Hadley Wickham’s answer to a SO question <a
href="https://stackoverflow.com/a/47123420/2641825">Why use purrr::map
instead of lapply?</a></p>
<div id="map-a-function-to-nested-data-sets" class="section level3">
<h3>Map a function to nested data sets</h3>
<p>Load data</p>
<pre class="r"><code>list.files(getwd())
forestEU_wide &lt;- read.csv(&quot;Forest-R-EU.csv&quot;, stringsAsFactors = FALSE)
head(forestEU)</code></pre>
<p>Pivot to long format</p>
<pre class="r"><code># at some pointin the future this will be called pivot_long
forestEU &lt;- forestEU_wide  %&gt;% 
      # select everything except the Year, then pivot all columns and put the value in area
      gather(-Year, key = &quot;Country&quot;, value = &quot;Area&quot;)</code></pre>
</div>
</div>
<div id="tricks" class="section level2">
<h2>Tricks</h2>
<p>David Robinson <a
href="https://www.youtube.com/watch?v=NDHSBUN_rVU">Ten tricks in the
tidyverse</a></p>
<ol style="list-style-type: decimal">
<li>count with weight, sort and renamining count(x, …, wt = NULL, sort =
FALSE, name = “n”)</li>
<li>creating variables in count()</li>
<li>add_count()</li>
<li>summarize with a list column (to create many models for
example)</li>
<li>fct_reorder() + geom_col() + coord_flip()</li>
<li>fct_lump() to lump less frequent values together</li>
<li>use a log scale scale_x/y_log10</li>
<li>crossing()</li>
<li>separate()</li>
<li>extract() use a regular expression such as <code>S(.*)E(.*)</code>
to extract series and episode from a string of the form “S32E44”.</li>
</ol>
</div>
<div id="purrr-1" class="section level2">
<h2>Purrr</h2>
<div id="interpolation" class="section level3">
<h3>Interpolation</h3>
<p>Interpolate for one country</p>
<pre class="r"><code>country_interpolation &lt;- function(df) {
    df &lt;- data.frame(approx(df$Year, df$Area, method = &quot;linear&quot;, n=71))
    df &lt;- rename(df, Year = x, Area = y)
    return(df)
}
forestEU %&gt;%
    filter(Country==&quot;Austria&quot;) %&gt;%
    country_interpolation()</code></pre>
<p>Interpolate for all countries Perform the Interpolation on all
countries</p>
<p>See documentation in * many models <a
href="https://r4ds.had.co.nz/many-models.html"
class="uri">https://r4ds.had.co.nz/many-models.html</a> * blog <a
href="https://emoriebeck.github.io/R-tutorials/purrr/"
class="uri">https://emoriebeck.github.io/R-tutorials/purrr/</a></p>
<pre class="r"><code>forestEU_nested &lt;- forestEU %&gt;%
      # Remove empty area
      filter(!is.na(Area)) %&gt;% 
      group_by(Country) %&gt;%  
      nest() %&gt;% 
      mutate(interpolated = map(data, country_interpolation))

# forestEU_nested %&gt;% unnest(data)
# Unnest the interpolated data to look at it and plotting
forestEU_interpolated &lt;- forestEU_nested %&gt;% unnest(interpolated)</code></pre>
</div>
<div id="read-many-csv" class="section level3">
<h3>Read many csv</h3>
<p>See iris_csv file created in the csv section of this document. Read
these csv files into one data frame. Note the Species column has to be
present in the csv files, otherwise we would loose that information.</p>
<pre class="r"><code>iris_csv &lt;- list.files(data_folder, full.names = TRUE) %&gt;% 
    purrr::map_dfr(read_csv)</code></pre>
</div>
<div id="write-to-many-csv" class="section level3">
<h3>Write to many csv</h3>
<pre class="r"><code>#dir.create(&quot;output&quot;)
forestEU_nested &lt;- forestEU_nested %&gt;% 
    mutate(filename = paste0(&quot;output/&quot;, Country, &quot;.csv&quot;),
    wrote_stuff = map2(interpolated, filename, write.csv))</code></pre>
</div>
</div>
<div id="tidy-evaluation" class="section level2">
<h2>tidy evaluation</h2>
<ul>
<li>Advanced R <a
href="https://adv-r.hadley.nz/meta.html">metaprogramming
section</a></li>
<li><a
href="https://www.tidyverse.org/articles/2018/07/ggplot2-tidy-evaluation/">Examples
of tidy evaluation with plots</a></li>
</ul>
<pre class="r"><code>scatter_plot &lt;- function(data, x, y) {
    x &lt;- enquo(x)
    y &lt;- enquo(y)
    ggplot(data) + geom_point(aes(!!x, !!y))
}
scatter_plot(mtcars, disp, drat)</code></pre>
<p>Another example use of metaprogramming to change variables</p>
<pre class="r"><code>add1000 &lt;- function(dtf, var){
      varright &lt;- enquo(var)
  varleft &lt;- quo_name(enquo(var))
    dtf %&gt;% 
            mutate(!!varleft := 1000 + (!!varright))
}
add1000(iris, Sepal.Length)</code></pre>
<ul>
<li><a href="https://thinkr.fr/tidyeval/">Tidy evaluation explained in
French</a></li>
</ul>
</div>
<div id="tidy-select" class="section level2">
<h2>Tidy select</h2>
<p>Tidy select <a
href="https://tidyselect.r-lib.org/reference/language.html">selection
language</a> explains the various selection function such as
<code>all_of</code>, <code>contains</code> and
<code>starts_with</code>.</p>
<pre class="r"><code>library(dplyr)
iris2 &lt;- head(iris, 1)
select(iris2, contains(&quot;w&quot;)) # Literal string
select(iris2, matches(&quot;w&quot;)) # Regular expression
select(iris2, starts_with(&quot;S&quot;))
select(iris2, all_of(c(&quot;Sepal.Length&quot;, &quot;Petal.Width&quot;)))</code></pre>
<p>The selection can be inverted by using s minus sign in front of it.
Not it’s not a question mark as explained in this <a
href="https://stackoverflow.com/a/45941792/2641825">SO answer</a>
because the selection fonctions return numerical vectors of integer
column positions (not boolean values).</p>
<pre class="r"><code>library(dplyr)
select(head(iris), -matches(&quot;w&quot;) )</code></pre>
</div>
<div id="tidyr" class="section level2">
<h2>tidyr</h2>
<p><a
href="https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html">tidyr
vignette on tidy data</a> In the section on “Multiple types in one
table”:</p>
<blockquote>
<p>Datasets often involve values collected at multiple levels, on
different types of observational units. During tidying, each type of
observational unit should be stored in its own table. This is closely
related to the idea of database normalisation, where each fact is
expressed in only one place. It’s important because otherwise
inconsistencies can arise.</p>
</blockquote>
<blockquote>
<p>Normalisation is useful for tidying and eliminating inconsistencies.
However, there are few data analysis tools that work directly with
relational data, so analysis usually also requires denormalisation or
the merging the datasets back into one table.</p>
</blockquote>
<p>Example use of <code>tidyr::nest()</code> to generate a group of
plots: <a
href="http://www.brodrigues.co/blog/2017-03-29-make-ggplot2-purrr/">make
ggplot2 purrr</a>.</p>
<pre class="r"><code>library(tidyr)
library(dplyr)
library(purrr)
library(ggplot2)
piris &lt;- iris %&gt;%  
    group_by(Species) %&gt;% 
    nest() %&gt;% 
    mutate(plot = map2(data, Species, 
                       ~ggplot(data = .x, 
                               aes(x = Petal.Length, y = Petal.Width)) + 
                           geom_point() + ggtitle(.y)))
piris$plot[1]
piris$plot[3]
piris$plot[2]</code></pre>
</div>
</div>
<div id="time-series" class="section level1">
<h1>Time series</h1>
<div id="moving-averages" class="section level2">
<h2>Moving averages</h2>
<p>Use the rollmean function from the zoo package. It defaults to
centered.</p>
<pre><code> library(zoo)
 x.Date &lt;- as.Date(paste(2004, rep(1:4, 4:1), sample(1:28, 10), sep = &quot;-&quot;))
 x &lt;- zoo(rnorm(12), x.Date)
 rollmean(x, 3, fill=NA)
 rollmean(x, 3, fill=&quot;extend&quot;)
 y &lt;- x
 y[&quot;2004-01-15&quot;] &lt;- NA
 rollmean(y, 3, fill=&quot;extend&quot;) 
 # Returns NA values if there are not enough observations for the rollmean
 rollmean(y, 9, fill=&quot;extend&quot;) 
 rollmean(x, 9, fill=&quot;extend&quot;) </code></pre>
</div>
</div>
<div id="working-directory" class="section level1">
<h1>Working directory</h1>
<p>Hadley Wickham on a <a
href="https://stackoverflow.com/questions/4216753/check-existence-of-directory-and-create-if-doesnt-exist">Stackoverflow
comment</a>:</p>
<blockquote>
<p>“You should never use setwd() in R code - it basically defeats the
idea of using a working directory because you can no longer easily move
your code between computers. – hadley Nov 20 ’10 at 23:44”</p>
</blockquote>
<p>Content copied from my <a
href="https://stackoverflow.com/a/47045842/2641825">StackOverflow
answer</a>.</p>
<p><strong>TLDR</strong>: The <a
href="https://cran.r-project.org/web/packages/here/index.html">here</a>
package (available on CRAN) helps you build a path from a project’s root
directory. R projects configured with <code>here()</code> can be shared
with colleagues working on different laptops or servers and paths built
relative to the project’s root directory will still work. The
development version is at <a
href="https://github.com/r-lib/here">github.com/r-lib/here</a>.</p>
<div id="with-git" class="section level2">
<h2>With git</h2>
<p>You certainly store your R code in a directory. This directory is
probably part of a git repository and/or an R studio project. I would
recommend building all paths relative to that project’s root directory.
For example let’s say that you have an R script that creates reusable
plotting functions and that you have an R markdown notebook that loads
that script and plots graphs in a nice (so nice) document. The project
tree would look something like this</p>
<pre><code>├── notebooks
│   ├── analysis.Rmd
├── R
│   ├── prepare_data.R
│   ├── prepare_figures.R</code></pre>
<p>From the <code>analysis.Rmd</code> notebook, you would import
plotting function with <code>here()</code> as such:</p>
<pre><code>source(file.path(here::here(&quot;R&quot;), &quot;prepare_figures.R&quot;))</code></pre>
</div>
<div id="why" class="section level2">
<h2>Why?</h2>
<p>From the <a href="https://github.com/jennybc/here_here#readme">Ode to
the here package</a>:</p>
<blockquote>
<p>Do you: Have setwd() in your scripts? PLEASE STOP DOING THAT. This
makes your script very fragile, hard-wired to exactly one time and
place. As soon as you rename or move directories, it breaks. Or maybe
you get a new computer? Or maybe someone else needs to run your code?
[…] Classic problem presentation: Awkwardness around building paths
and/or setting working directory in projects with subdirectories.
Especially if you use R Markdown and knitr, which trips up alot of
people with its default behavior of “working directory = directory where
this file lives”. […]</p>
</blockquote>
<p>Install the <a
href="https://cran.r-project.org/web/packages/here/index.html">here</a>
package:</p>
<pre><code>install.packages(&quot;here&quot;)
library(here)
here()
here(&quot;construct&quot;,&quot;a&quot;,&quot;path&quot;)</code></pre>
<p>Documentation of the <code>here()</code> function:</p>
<blockquote>
<p>Starting with the current working directory during package load time,
here will walk the directory hierarchy upwards until it finds a
directory that satisfies at least one of the following conditions:</p>
<ul>
<li>contains a file matching [.]Rproj$ with contents matching ^Version:
in the first line</li>
<li>[… other options …]</li>
<li>contains a directory .git</li>
</ul>
<p>Once established, the root directory doesn’t change during the active
R session. here() then appends the arguments to the root directory.</p>
</blockquote>
<p>The development version of the <a
href="https://github.com/r-lib/here">here package is available on
github</a>.</p>
</div>
<div id="what-about" class="section level2">
<h2>What about</h2>
<div id="what-about-files-outside-the-project-directory"
class="section level3">
<h3>What about files outside the project directory?</h3>
<p>If you are loading or sourcing files outside the project directory,
the recommended way is to use an environment variable at the Operating
System level. Other users of your R code on different laptops or servers
would need to set the same environment variable. The advantage is that
it is portable.</p>
<pre><code>data_path &lt;- Sys.getenv(&quot;PROJECT_DATA&quot;)
df &lt;- read.csv(file.path(data_path, &quot;file_name.csv&quot;))</code></pre>
<p>Note: There is a long list of <a
href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/EnvVar.html">environmental
variables</a> which can affect an R session.</p>
</div>
<div id="what-about-many-projects-sourcing-each-other"
class="section level3">
<h3>What about many projects sourcing each other?</h3>
<p>It’s time to <a href="https://r-pkgs.org/">create an R
package</a>.</p>
</div>
</div>
</div>
<div id="further-resources" class="section level1">
<h1>Further resources</h1>
<div id="blogs" class="section level2">
<h2>Blogs</h2>
<ul>
<li><p><a href="https://www.tinyverse.org/">tinyverse</a> “Lightweight
is the right weight”</p>
<ul>
<li><p>Dirk Eddelbuettel <a
href="http://dirk.eddelbuettel.com/blog/2018/02/28/#017_dependencies">dependencies</a></p>
<blockquote>
<p>“I relied on the liteq package by Gabor which does the job: enqueue
jobs, and reliably dequeue them (also in a parallel fashion) and more.
It looks light enough:”</p>
</blockquote>
<pre><code>  R&gt; tools::package_dependencies(package=&quot;liteq&quot;, recursive=FALSE, db=AP)$liteq
  [1] &quot;assertthat&quot; &quot;DBI&quot;        &quot;rappdirs&quot;   &quot;RSQLite&quot;</code></pre>
<blockquote>
<p>“Two dependencies because it uses an internal SQLite database, one
for internal tooling and one for configuration.” All good then? Not so
fast. The devil here is the very innocuous and versatile RSQLite package
because when we look at fully recursive dependencies all hell breaks
loose: Now we went from four to twenty-four, due to the twenty-two
dependencies pulled in by RSQLite.”</p>
</blockquote></li>
</ul></li>
<li><p>Gavin Simpson <a
href="http://www.fromthebottomoftheheap.net/2015/06/03/my-aversion-to-pipes/">My
aversion to pipers</a> shows an Hadley tweet explaining that pipe might
not be good in package development.</p></li>
<li><p>5 R packages for text analysis <a
href="https://towardsdatascience.com/r-packages-for-text-analysis-ad8d86684adb"
class="uri">https://towardsdatascience.com/r-packages-for-text-analysis-ad8d86684adb</a></p></li>
</ul>
</div>
<div id="shiny-apps-by-international-organizations"
class="section level2">
<h2>Shiny apps by international organizations</h2>
<ul>
<li>The human mortality database <a
href="https://mpidr.shinyapps.io/stmortality/">short term mortality
fluctuations visualization toolkit</a>, <a
href="https://github.molgen.mpg.de/nemeth/stmortality">Git
repository</a>, <a
href="https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0246663">Plos
One paper</a></li>
</ul>
</div>
<div id="stackoverflow" class="section level2">
<h2>Stackoverflow</h2>
<ul>
<li><a
href="https://codeblog.jonskeet.uk/2012/11/24/stack-overflow-question-checklist/">Stack
overflow question checklist</a> general programming</li>
<li><a
href="https://stackoverflow.com/questions/5963269/how-to-make-a-great-r-reproducible-example">How
to make a great R reproducible example</a></li>
</ul>
</div>
<div id="teaching-r" class="section level2">
<h2>Teaching R</h2>
<ul>
<li><p><a href="http://varianceexplained.org/r/teach-tidyverse/">Teach
the tidyverse to beginners</a></p></li>
<li><p><a
href="http://www.noamross.net/blog/2014/4/16/vectorization-in-r--why.html">Vectorization
in R, Why?</a></p></li>
<li><p><a
href="https://github.com/carpentries/conversations/issues/18">Recommendations
for resources for after workshops</a></p></li>
<li><p><a href="https://education.rstudio.com/learn/">Rstudio
education</a></p></li>
</ul>
<div id="economics" class="section level3">
<h3>Economics</h3>
<ul>
<li><a
href="https://www.econometrics-with-r.org/index.html">Introduction to
econometrics with R</a></li>
</ul>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
